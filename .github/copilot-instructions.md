<!-- Copilot / AI Agent Instructions for SIFCO-inv -->

This file contains quick, actionable guidance to help AI coding agents and contributors be productive in this repository.

1) Project summary
- Laravel v12 + PHP 8.2, Filament v4 admin UI. This repo is an inventory/stock management system.
- Key domain concepts: Product, Roll (bobine), Warehouse, StockQuantity, StockMovement, and business flows: Bon d'Entrée (receptions), Bon de Sortie (issues), Bon de Transfert (warehouse transfers), Bon de Réintégration (returns/putbacks).

2) Where to look (key files/directories)
- app/Models: domain models (e.g., `Product`, `Roll`, `StockQuantity`, `StockMovement`). Check `Roll::STATUS_*` constants and accessors.
- app/Services: domain logic lives here (e.g., `BonEntreeService`, `BonSortieService`, `BonTransfertService`, `CumpCalculator`). Services use DB transactions and may throw Exceptions to bubble up errors.
- app/Filament/Resources: Filament resources + pages — UI wiring and field validation. Examples: `CreateBonEntree` uses `mutateFormDataBeforeCreate` & `validateBusinessRules()`.
- tools/: handy scripts for quick local checks: `create_bonentree_test.php`, `generate_check.php`, `gencode_update_sim.php`, `bon_entree_info.php` — use for manual verification.
- database/migrations + database/seeders: schema + seeds.
- APP_OVERVIEW.md, LOGIC.md, PLAN.md: canonical documentation and flow diagrams.

3) Development & test workflow (commands)
- Quick setup (recommended):
	- composer run-script setup
	- or run the steps manually: `composer install; npm install; cp .env.example .env; php artisan key:generate; php artisan migrate; npm run build`
- Dev: `composer run-script dev` runs server, queue listener, logs, and vite in parallel.
- Tests: `composer test` (runs `php artisan test` — the default test environment uses SQLite :memory: in `phpunit.xml`).
- Build assets: `npm run build`. Local dev watch: `npm run dev`/`npm run build --watch`.

4) Architecture & conventions (patterns to follow)
- Two-tier product attributes: `type` (UI family, e.g., `papier_roll`, `consommable`, `fini`) vs `product_type` (business classification: `raw_material`, `semi_finished`, `finished_good`, `consumable`, `equipment`, `other`). Use `Product::typeOptions()` and `Product::productTypeOptions()`.
- Products may be `is_roll` (bobines) or sheet/pallet items; rolls are persisted in the `Roll` model and tracked with lifecycle events. See `Roll::STATUS_*` constants and `RollLifecycleEvent` handlers.
- Business logic belongs in `app/Services`. Services use `DB::beginTransaction()` / commit/rollback, Log::info for traceability, and throw Exceptions for precondition failures (tests assert these behaviors). Example flows:
	- `BonEntreeService::receive()` → creates `Roll` records (for rolls), `StockMovement` and updates `StockQuantity` using `CumpCalculator::calculate()`.
	- `BonSortieService::issue()` → consumes stock, potentially rolling/adjusting `Roll` records and emitting `RollLifecycleEvent`.
- Filament patterns: use `mutateFormDataBeforeCreate()` to set form defaults (status, totals) and `afterCreate()` to trigger recalculation or notifications. Use `Schema::hasColumn` guards when referencing optional columns.
- Movement numbering: `MOV-YYYYMMDD-XXXX` — generated by `generateMovementNumber()` helper (or in StockMovement creation in UI). Use existing helpers when creating movements.

5) Tests & CI
- `phpunit.xml` is configured to use `sqlite :memory` for fast tests. Tests assume transactional DB state and often `actingAs()` for authenticated behavior.
- Use factories & seeders when creating entities in tests (e.g., `ProductFactory`, `RollFactory`).
- Run `composer test` locally and avoid leaving tests failing on branches.

6) Naming & numbering conventions
- Movement numbers follow `MOV-YYYYMMDD-XXXX` — use generator helpers in services or `StockMovement::create` call sites.
- Product codes are generated by `App\Models\Product::generateCode()` (see `tools/generate_check.php` and `gencode_update_sim.php` for usage). The UI `CreateProduct` may mutate data and call `generateCode()`.

7) Common pitfalls & gotchas
- Changes in Filament forms must be backwards compatible: always guard optional columns with `Schema::hasColumn` to avoid runtime errors on environments without that migration.
- Tests and services assume `Auth::id()` is set; use `actingAs($user)` in tests or default `Auth::id() ?? 1` used in some service call sites.
- Avoid editing pivot `is_primary` manually. Use `CreateProduct::syncPrimaryCategory()` / Edit logic.
- Services expect precondition checks — follow the service pattern of validating -> DB transaction -> actions -> commit.

8) Example places to copy patterns from
- `app/Services/BonEntreeService.php` — reception flow, bobine roll creation, stock movements, CUMP usage.
- `app/Services/BonSortieService.php` — issue flow & roll consumption logic.
- `app/Services/CumpCalculator.php` — single-responsibility math for CUMP / cost averaging.
- `app/Models/Roll.php` — roll lifecycle constants and accessors.
- `app/Filament/Resources` & `app/Filament/Resources/*/Pages/*` — form mutators `mutateFormDataBeforeCreate`, `afterCreate`, notifications and validators.
- `tools/` — small manual PHP scripts for quick checks (`create_bonentree_test.php`, `gencode_update_sim.php`).

Product code generation
- `Product::generateCode()` forms product codes; it's used in the Filament `CreateProduct::mutateFormDataBeforeCreate()` and in a `Product` creating hook.
- Use `tools/generate_check.php` / `tools/gencode_update_sim.php` to simulate and validate expected code generation.

9) Pull request guidance for agents
- Keep PRs small and focused. Run `composer test` and ensure local migration/setup runs.
- Add or update automated tests for behavior changes (happy path + key edge cases).
- Update `APP_OVERVIEW.md`, `LOGIC.md`, `PLAN.md` when changes affect business flows.
- Preserve service and CUMP logic in `app/Services` for domain changes; prefer new service methods over controller or resource logic.

10) Quick search hints for the agent
- Useful search tokens: `BonEntreeService`, `BonSortieService`, `CumpCalculator`, `RollLifecycleEvent`, `StockMovement`, `StockQuantity`, `is_roll`, `product_type`, `sourceable_type`, `generateMovementNumber`, `mutateFormDataBeforeCreate`.

If any section is unclear or you want this shortened or expanded, say which area you'd like more detail on (services, Filament forms, testing, migrations, or packaging commands). 
