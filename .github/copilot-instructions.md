<!-- Copilot / AI Agent Instructions for SIFCO-inv -->

This file contains quick, actionable guidance to help AI coding agents be productive in this repository.

1) Project summary
- Laravel (v12), Filament v4, PHP 8.2 inventory/stock system. Key domain concepts: Products, Rolls (bobines), Warehouses, StockQuantities, StockMovements, and four procedures: Bon d'Entrée, Bon de Sortie, Bon de Transfert, Bon de Réintégration.

2) Where to look (key files/directories)
- app/Models: domain models (Product, Roll, StockQuantity, StockMovement)
- app/Services: business logic (BonEntreeService, BonSortieService, BonTransfertService, CumpCalculator)
- app/Filament/Resources: UI (Products, BonEntrees, BonSorties, Rolls etc.) and pages
- database/migrations, database/seeders: schema + seeders
- APP_OVERVIEW.md, LOGIC.md, PLAN.md: canonical documentation. Keep them updated with behavior changes.

3) Development & test workflow (commands)
- Quick setup: composer install; npm install; copy .env.example to .env; php artisan key:generate; php artisan migrate; npm run build
- Combined setup (composer script): composer run-script setup (defined in composer.json)
- Local dev (one command to run the whole developer stack): composer run-script dev
- Tests: composer test (php artisan test uses sqlite :memory: by default; use phpunit directly or composer test)

4) Architecture & conventions (patterns to follow)
- Two-tier product attributes: `type` (UI family e.g., papier_roll/consommable/fini) and `product_type` (business classification: raw_material/semi_finished/finished_good). Use `Product::typeOptions()` / `productTypeOptions()` as local helpers.
- `is_roll` boolean indicates physical bobines; `Roll` model persists per bobine data. Roll lifecycle: STATUS_IN_STOCK, RESERVED, CONSUMED, DAMAGED, ARCHIVED.
- Business logic lives in app/Services. Use these services over embedding business logic in controllers. Example classes: `BonEntreeService::receive()`, `BonSortieService::issue()`, `CumpCalculator::calculate()`.
- CUMP (weighted average) is calculated by `CumpCalculator`; stock movement and stock quantities are updated per service.
- Filament forms often use 2 repeaters for Bobines vs Products (bon resources). For Filament, reactive fields, Section components and `modifyQueryUsing` are frequently used.
- Use `Schema::hasColumn` guards for UI form fields that rely on new migrations (e.g., length/width fields). This avoids runtime failure when migrations are lagging in CI or local environments.
- Polymorphism pattern: `BonEntree::sourceable` and `BonSortie::destinationable` (e.g., Supplier | ProductionLine | Client). Data migrations use `sourceable_type`/`id` and `destinationable_type`/`id` columns.

5) Tests & CI
- phpunit.xml uses sqlite :memory: to run tests. Transactional DB state is assumed in many unit tests. When writing tests, use factories and seeders, and respect `php artisan migrate` in memory first.
- Run `composer test` or `php artisan test` before creating PRs; CI will run the same.

6) Naming & numbering conventions
- Stock movements use `MOV-YYYYMMDD-XXXX` generated by `generateMovementNumber()` in services. Use existing helpers when creating movements.

7) Common pitfalls & gotchas
- Don't update pivot metadata manually when creating the Product; let `CreateProduct` / `EditProduct` sync `is_primary` pivot (see `CreateProduct::syncPrimaryCategory()`).
- Services frequently throw `Exception` on precondition failures to bubble to callers—tests assert these exceptions in negative flows.
- Some code relies on `Auth::id()` returning a value; use test user creation or `actingAs` in tests when needed.
- When adding DB columns used by Filament forms (e.g., `length_m`), add migration + guard logic in the form to avoid runtime errors.

8) Example places to copy patterns from
- `app/Services/BonEntreeService.php`: validate/receive workflow pattern; CUMP update; Roll creation.
- `app/Services/BonSortieService.php`: issue; roll consumption; stock movement and quantity decrement.
- `app/Models/Roll.php`: lifecycle constants and accessors for weight/cump/length.
- `app/Filament/Resources/Products/Pages/CreateProduct.php`: pivot sync logic example.
- `phpunit.xml`: memory sqlite setup for tests.

Product code generation
- The generator is implemented at `App\Models\Product::generateCode()` and produces codes like `PROD-AB1-001` or `CONS-XY2-001` based on name and product type.
- Server-side auto-generation happens in two places: `CreateProduct::mutateFormDataBeforeCreate()` will generate a code when the form is saved, and the `Product` model `creating` hook will generate one if it's missing (ensuring direct API or seed insertions also get codes).
- Tests for the generator are in `tests/Feature/ProductCodeGenerationTest.php`.

9) Pull request guidance for agents
- Tests must pass locally. Update canonical docs (`APP_OVERVIEW.md`, `LOGIC.md`, `PLAN.md`) for behavior changes. Prefer small, single-purpose commits. Prefer adding or updating unit/feature tests when changing business logic.

10) Quick search hints for the agent
- Search the repo for `BonEntreeService`, `BonSortieService`, `CumpCalculator`, `RollLifecycleEvent`, `StockMovement`, `StockQuantity`, `is_roll`, `product_type`, `sourceable_type`.

If any section is unclear or you want this shortened or expanded, say which area you'd like more detail on (services, Filament forms, testing, migrations, or packaging commands).
